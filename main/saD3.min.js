/**
 *  @fileOverview saD3 is a javascript library extending the d3
 * functionality of common graphs matching the conventions perscribed
 * by the author
 *
 *  @author       Jamie Sgro
 *
 *  @requires     {@link https://d3js.org/d3.v5.min.js d3.v5}
 *
 *  @license
 *     Copyright 2019 Sangwa / Sangwa Libraries
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License
 */
class Base_D3{constructor(t,e,a,i,r){this.basePath=this.getBasePath(["Base_D3.js","saD3.js"]),this.id=t,this.margin=i,this.width=e-this.margin.left-this.margin.right,this.height=a-this.margin.top-this.margin.bottom,this.colourBottom=r.bottom,this.colourTop=r.top,this.max=0,this.min=0,this.widthScale=function(){},this.heightScale=function(){},this.colour_D3=new Colour_D3,this.getColour=this.colour_D3.getColour,this._getAttr_fill=this.colour_D3._getAttr_fill,this._getAttr_fillTransparent=this.colour_D3._getAttr_fillTransparent,this.setAlpha=this.colour_D3.setAlpha,this.pub_D3=new Pub_D3,this.makePubBtn=this.pub_D3.makePubBtn,this.getSvgSize=function(t,e){t.attr("width",e.width+e.margin.left+e.margin.right).attr("height",e.height+e.margin.top+e.margin.bottom)},this.div=d3.select("body").append("div"),this.svg=this.div.append("svg").attr("id",t).attr("class","graph svg").call(this.getSvgSize,this),this.canvas=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")}getBasePath(t){if(!Array.isArray(t))throw"Error in getBasePath(): param 'targetFile' needs to be an array";var e=document.getElementsByTagName("script");for(var a in e)if(null!=e[a].src){var i=e[a].src.split("/"),r=i[i.length-1];for(var s in t)if(r===t[s]){var n=e[a].src;return n=n.substr(0,n.length-t[s].length)}}throw"Error in getBasePath(): could not find targetFile in getBasePath()"}getDomain(t){return[d3.min(t),d3.max(t)]}prePlot(){}_getAttr_x(t,e){t.attr("x",function(t){return e._x(t,e)})}_getAttr_y(t,e){t.attr("y",function(t){return e._y(t,e)})}_getAttr_width(t,e){t.attr("width",e._width(t,e))}_getAttr_height(t,e){t.attr("height",function(t){return e._height(t,e)})}getAttr(t,e,a){for(var i in a)e["_getAttr_"+a[i]](t,e)}getXAxis(t,e){t.attr("transform","translate(0,"+e.height+")").call(d3.axisBottom(e.getWidthScale(e.domain)))}getYAxis(t,e,a){t.call(d3.axisLeft(e.getHeightScale(a)))}plot(t){var e=this.prePlot(t);this.canvas.selectAll("rect.bar").data(e).enter().append("rect").attr("class","bar pub resizable").attr("height",0).attr("y",this.height).call(this.getAttr,this,["x","width","fill"]),this.canvas.append("g").attr("class","xAxis axis pub resizable").call(this.getXAxis,this),this.canvas.append("g").attr("class","yAxis axis pub resizable").call(this.getYAxis,this,e),this.makePubBtn(),this.postPlot(e)}update(t,e){var a=new Motion_D3;this.canvas.selectAll("rect.bar").data(t).each(function(t){d3.select(this).call(a.attrTween,800,"height",e._height(t,e)),d3.select(this).call(a.attrTween,800,"y",e._y(t,e))})}}class Motion_D3{constructor(){}attrTween(t,e,a,i){d3.select({}).transition().duration(e).tween(a,function(){var e=d3.interpolate(t.attr(a),i);return function(i){t.attr(a,e(i))}})}resetTween(t,e,a,i,r){d3.select({}).transition().duration(e).tween(a,function(){var e=d3.interpolate(t.attr(a),r);return function(i){t.attr(a,e(i))}}).transition().duration(3*e).tween(a,function(){var e=d3.interpolate(r,i);return function(i){t.attr(a,e(i))}})}}class Colour_D3{constructor(){}getColour(t){var e=this.yLabel;return d3.scaleLinear().domain([0,d3.max(t,function(t){return t[e]})]).range([this.colourBottom,this.colourTop])}_getAttr_fill(t,e){var a=e.getColour(t.data());t.attr("fill",function(t){return a(t[e.yLabel])})}_getAttr_fillTransparent(t,e){var a=e.getColour(t.data());t.attr("fill",function(t){return rtn=a(t[e.yLabel]),setAlpha(rtn,0)})}setAlpha(t,e){return(t=d3.rgb(t)).opacity=e,t}}class Pub_D3{constructor(){}makePubBtn(){var t=this,e=this.setAlpha(this.colourTop,"0.7");this.canvas.append("g").attr("class","menu resizable").append("rect").attr("x",t.width+t.margin.right-40).attr("y",0-t.margin.top-40).attr("width",80).attr("height",80).attr("transform","rotate(45, "+(t.width+t.margin.right)+", "+(0-t.margin.top)+")").attr("fill",e).style("cursor","pointer").on("mouseover",function(){d3.select(this).attr("fill",t.setAlpha(e,1))}).on("mouseout",function(){d3.select(this).attr("fill",e)}).on("click",function(){d3.select(this).attr("fill",t.setAlpha(e,0)),saveSvgAsPng(document.getElementById(t.id),t.id+".png",{scale:2,backgroundColor:"#FFFFFF"})}),this.div.append("img").attr("class","picture resizable").attr("src",function(e){return t.basePath+"/images/file-image-regular.svg"}).on("error",function(){console.log("error in retrieving image")}).style("width","20px").style("position","absolute").style("left",function(){var e=document.getElementById(t.id).getBoundingClientRect().right;return e-=20,(e-=2).toString()+"px"}).style("top",function(){var e=document.getElementById(t.id).getBoundingClientRect().top;return(e+=2).toString()+"px"}).style("pointer-events","none")}}class _Int{constructor(){}getWidthScale(t){return d3.scaleLinear().domain([0,t[1]]).rangeRound([0,this.width]).nice()}parseRawData_one(t,e){return e.map(function(e,a){return parseFloat(e[t.yLabel])})}parseRawData_two(t,e){return e.map(function(e,a){return{[t.xLabel]:parseFloat(e[t.xLabel]),[t.yLabel]:parseFloat(e[t.yLabel])}})}}class _Date{constructor(){this.parseTime=d3.timeParse("%Y-%m-%d")}getWidthScale(t){return d3.scaleTime().domain(t).rangeRound([0,this.width]).nice()}parseRawData_one(t,e){return e.map(function(e,a){return t._date.parseTime(e[t.yLabel])})}parseRawData_two(t,e){return e.map(function(e,a){return{[t.xLabel]:t._date.parseTime(e[t.xLabel]),[t.yLabel]:e[t.yLabel]}})}}class Histogram extends Base_D3{constructor(t,e,a,i,r,s,n="value"){super(t,e,a,i,r),this.binNum=s,this.yLabel=n}getHeightScale(t){return d3.scaleLinear().domain([0,d3.max(t,function(t){return t.length})]).range([this.height,0])}getWidthScale(){}getBins(t,e){return d3.histogram().domain(t.widthScale.domain()).thresholds(t.widthScale.ticks(t.binNum))(e)}_x(t,e){return e.widthScale(t.x0)}_y(t,e){return e.heightScale(t[e.yLabel])}_width(t,e){var a=t.data();return e.widthScale(a[0].x1)-e.widthScale(a[0].x0)-1}_height(t,e){return e.height-e.heightScale(t[e.yLabel])}parseRawData(t){}prePlot(t){var e=this.parseRawData(this,t);this.domain=this.getDomain(e),this.widthScale=this.getWidthScale(this.domain);var a=this.getBins(this,e);return this.heightScale=this.getHeightScale(a),this.yLabel="length",a}postPlot(t){this.canvas.selectAll("rect.bar").attr("transform","translate(1,0)"),this.update(t,this)}}class Histogram_Int extends Histogram{constructor(t,e,a,i,r,s,n){super(t,e,a,i,r,s,n),this._int=new _Int,this.getWidthScale=this._int.getWidthScale,this.parseRawData=this._int.parseRawData_one}}class Histogram_Date extends Histogram{constructor(t,e,a,i,r,s,n){super(t,e,a,i,r,s,n),this._date=new _Date,this.getWidthScale=this._date.getWidthScale,this.parseRawData=this._date.parseRawData_one}}class Bargraph extends Base_D3{constructor(t,e,a,i,r,s="value",n="start_date"){super(t,e,a,i,r),this.xLabel=n,this.yLabel=s}getHeightScale(t){var e=this.yLabel;return d3.scaleLinear().domain([0,d3.max(t,function(t){return t[e]})]).range([this.height,0])}getWidthScale(){}_x(t,e){return e.widthScale(t[e.xLabel])}_y(t,e){return e.heightScale(t[e.yLabel])}_width(t,e){var a=t.data().map(function(t){return t[e.xLabel]}),i=d3.extent(a),r=d3.timeDay.count(i[0],i[1])+1;return e.width/r}_height(t,e){return e.height-e.heightScale(t[e.yLabel])}prePlot(t){var e=this.parseRawData(this,t),a=this.xLabel,i=e.map(function(t){return t[a]});return this.domain=this.getDomain(i),this.domain[1]=d3.timeDay.offset(this.domain[1],1),this.widthScale=this.getWidthScale(this.domain),this.heightScale=this.getHeightScale(e),e}postPlot(t){this.update(t,this)}}class Bargraph_Date extends Bargraph{constructor(t,e,a,i,r,s,n){super(t,e,a,i,r,s,n),this._date=new _Date,this.getWidthScale=this._date.getWidthScale,this.parseRawData=this._date.parseRawData_two}}
